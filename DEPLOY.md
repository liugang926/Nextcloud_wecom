# éƒ¨ç½²å’Œæ›´æ–°æŒ‡å—

## ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ›´æ–°æ’ä»¶

### ç¬¬1æ­¥ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
# SSH ç™»å½•åˆ°æœåŠ¡å™¨
ssh user@cloud.top-leading.com

# è¿›å…¥æ’ä»¶ç›®å½•ï¼ˆæ ¹æ®å®é™…è·¯å¾„è°ƒæ•´ï¼‰
cd /var/www/nextcloud/apps/oauthwecom

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main
```

### ç¬¬2æ­¥ï¼šé‡æ–°å¯ç”¨æ’ä»¶

```bash
# è¿›å…¥ NextCloud æ ¹ç›®å½•
cd /var/www/nextcloud

# ç¦ç”¨æ’ä»¶
sudo -u www-data php occ app:disable oauthwecom

# æ¸…é™¤ç¼“å­˜
sudo -u www-data php occ maintenance:repair

# é‡æ–°å¯ç”¨æ’ä»¶
sudo -u www-data php occ app:enable oauthwecom
```

### ç¬¬3æ­¥ï¼šéªŒè¯å®‰è£…

```bash
# æ£€æŸ¥æ’ä»¶çŠ¶æ€
sudo -u www-data php occ app:list | grep oauthwecom
# åº”æ˜¾ç¤º: oauthwecom (enabled)

# æ£€æŸ¥è·¯ç”±
sudo -u www-data php occ app:routes oauthwecom
```

### ç¬¬4æ­¥ï¼šè®¿é—®è®¾ç½®é¡µé¢

æ›´æ–°åï¼Œç®¡ç†å‘˜è®¾ç½®é¡µé¢çš„ä½ç½®ï¼š

**æ–¹å¼1ï¼šé€šè¿‡å¯¼èˆªèœå•**
1. ç™»å½• NextCloud ç®¡ç†å‘˜è´¦å·
2. ç‚¹å‡»å³ä¸Šè§’å¤´åƒ â†’ ç®¡ç†è®¾ç½®
3. åœ¨å·¦ä¾§èœå•æ‰¾åˆ° **"ä¼ä¸šå¾®ä¿¡è®¤è¯"** åŒºåŸŸ
4. ç‚¹å‡»è¿›å…¥é…ç½®é¡µé¢

**æ–¹å¼2ï¼šç›´æ¥è®¿é—®URL**
```
https://cloud.top-leading.com/settings/admin/oauthwecom
```

## âœ… å…³é”®å˜æ›´è¯´æ˜

### æœ¬æ¬¡æ›´æ–°ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **æƒé™é—®é¢˜** âœ“
   - ç§»é™¤äº†ä¸æ­£ç¡®çš„ `NoAdminRequired` æ³¨è§£
   - ç°åœ¨åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®é…ç½®æ¥å£
   - è§£å†³äº†"æ²¡æœ‰æƒé™"çš„æç¤ºé—®é¢˜

2. **è®¾ç½®é¡µé¢æ˜¾ç¤º** âœ“
   - åˆ›å»ºäº†ç‹¬ç«‹çš„"ä¼ä¸šå¾®ä¿¡è®¤è¯"è®¾ç½®åŒºåŸŸ
   - ä¸å†éšè—åœ¨"å®‰å…¨"åˆ†ç±»ä¸‹
   - åœ¨å·¦ä¾§èœå•ä¸­æœ‰ä¸“å±å…¥å£

3. **è·¯ç”±æ³¨å†Œ** âœ“
   - æ­£ç¡®æ³¨å†Œäº† AdminSection
   - è®¾ç½®é¡µé¢ä½¿ç”¨è‡ªå®šä¹‰ section ID

## ğŸ” éªŒè¯æ¸…å•

æ›´æ–°å®Œæˆåï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] æ’ä»¶çŠ¶æ€ä¸º enabled
- [ ] å¯ä»¥çœ‹åˆ°"ä¼ä¸šå¾®ä¿¡è®¤è¯"èœå•é¡¹
- [ ] å¯ä»¥è®¿é—®é…ç½®é¡µé¢
- [ ] é¡µé¢æ ·å¼æ­£å¸¸
- [ ] ä¿å­˜é…ç½®åŠŸèƒ½æ­£å¸¸
- [ ] æµ‹è¯•è¿æ¥åŠŸèƒ½å¯ç”¨

## ğŸ“ æ–‡ä»¶ç»“æ„è¯´æ˜

```
lib/
â”œâ”€â”€ AppInfo/
â”‚   â””â”€â”€ Application.php         # æ³¨å†Œ AdminSection å’Œ AdminSettings
â”œâ”€â”€ Controller/
â”‚   â””â”€â”€ AdminController.php     # ç®¡ç†æ¥å£ï¼ˆä»…ç®¡ç†å‘˜å¯è®¿é—®ï¼‰
â””â”€â”€ Settings/
    â”œâ”€â”€ AdminSection.php        # è‡ªå®šä¹‰è®¾ç½®åŒºåŸŸï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ AdminSettings.php       # è®¾ç½®é¡µé¢ç±»
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè¿˜æ˜¯çœ‹ä¸åˆ°"ä¼ä¸šå¾®ä¿¡è®¤è¯"èœå•

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. å®Œå…¨æ¸…é™¤ç¼“å­˜
sudo -u www-data php occ maintenance:mode --on
sudo -u www-data php occ maintenance:repair
sudo -u www-data php occ maintenance:mode --off

# 2. é‡å¯ PHP-FPM
sudo systemctl restart php-fpm
# æˆ–
sudo systemctl restart php8.1-fpm

# 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# æŒ‰ Ctrl+Shift+Delï¼Œæ¸…é™¤æ‰€æœ‰ç¼“å­˜
```

### é—®é¢˜2ï¼šæç¤º"æ²¡æœ‰æƒé™"

**åŸå› ï¼š** å½“å‰ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
sudo -u www-data php occ user:info your_username

# å¦‚æœä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ç®¡ç†å‘˜æƒé™
sudo -u www-data php occ group:adduser admin your_username
```

### é—®é¢˜3ï¼šé¡µé¢æ˜¾ç¤ºç©ºç™½æˆ–é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -50 /var/www/nextcloud/data/nextcloud.log

# æ£€æŸ¥ PHP é”™è¯¯æ—¥å¿—
tail -50 /var/log/php-fpm/error.log
```

## ğŸ“ è·å–æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   tail -100 /var/www/nextcloud/data/nextcloud.log | grep -i oauthwecom
   ```

2. **è¿è¡Œè¯Šæ–­è„šæœ¬**
   ```bash
   cd /var/www/nextcloud/apps/oauthwecom
   chmod +x debug.sh
   ./debug.sh /var/www/nextcloud
   ```

3. **æäº¤Issue**
   
   åœ¨ GitHub ä¸Šæäº¤ Issueï¼š
   https://github.com/liugang926/Nextcloud_wecom/issues
   
   è¯·åŒ…å«ï¼š
   - NextCloud ç‰ˆæœ¬
   - PHP ç‰ˆæœ¬
   - é”™è¯¯æ—¥å¿—
   - è¯Šæ–­è„šæœ¬è¾“å‡º

## ğŸ‰ é…ç½®ä¼ä¸šå¾®ä¿¡

æ›´æ–°å®Œæˆåï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š

### 1. åœ¨ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°

1. è®¿é—®ï¼šhttps://work.weixin.qq.com/
2. åˆ›å»ºè‡ªå»ºåº”ç”¨
3. è®°å½•ï¼šä¼ä¸šIDã€AgentIDã€Secret
4. è®¾ç½®æˆæƒå›è°ƒåŸŸï¼š`cloud.top-leading.com`

### 2. åœ¨ NextCloud é…ç½®

1. è®¿é—®ï¼šhttps://cloud.top-leading.com/settings/admin/oauthwecom
2. å¡«å†™ä¼ä¸šå¾®ä¿¡ä¿¡æ¯
3. ç‚¹å‡»"æµ‹è¯•è¿æ¥"
4. ä¿å­˜è®¾ç½®

### 3. æµ‹è¯•ç™»å½•

1. é€€å‡ºå½“å‰ç™»å½•
2. åœ¨ç™»å½•é¡µé¢åº”è¯¥èƒ½çœ‹åˆ°"ä¼ä¸šå¾®ä¿¡ç™»å½•"æŒ‰é’®
3. ç‚¹å‡»æµ‹è¯•ç™»å½•æµç¨‹

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.1 (2024-11-13)
- âœ… ä¿®å¤ç®¡ç†å‘˜æƒé™éªŒè¯é—®é¢˜
- âœ… åˆ›å»ºç‹¬ç«‹çš„è®¾ç½®åŒºåŸŸ
- âœ… ä¼˜åŒ–è®¾ç½®é¡µé¢è®¿é—®è·¯å¾„
- âœ… æ·»åŠ è¯¦ç»†çš„éƒ¨ç½²å’Œæ•…éšœæ’æŸ¥æ–‡æ¡£

### v1.0.0 (2024-11-12)
- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒä¼ä¸šå¾®ä¿¡ OAuth 2.0 è®¤è¯
- âœ… æ”¯æŒç”¨æˆ·å’Œç»„ç»‡æ¶æ„åŒæ­¥
- âœ… å®Œæ•´çš„å®¡è®¡æ—¥å¿—åŠŸèƒ½

## ğŸ” å®‰å…¨æç¤º

1. **åªä½¿ç”¨ HTTPS**
   
   ç¡®ä¿æ‚¨çš„ NextCloud ä½¿ç”¨ HTTPSï¼Œå¦åˆ™ä¼ä¸šå¾®ä¿¡å¯èƒ½æ‹’ç»æˆæƒã€‚

2. **ä¿æŠ¤ Secret**
   
   ä¼ä¸šå¾®ä¿¡çš„ Secret éå¸¸æ•æ„Ÿï¼Œè¯·å‹¿æ³„éœ²ã€‚

3. **å®šæœŸæ›´æ–°**
   
   å®šæœŸæ£€æŸ¥å¹¶æ›´æ–°æ’ä»¶åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

4. **ç›‘æ§æ—¥å¿—**
   
   å®šæœŸæŸ¥çœ‹å®¡è®¡æ—¥å¿—ï¼Œäº†è§£ç™»å½•æƒ…å†µã€‚

---

**æ›´æ–°æ—¶é—´ï¼š** 2024-11-13  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** v1.0.1+

